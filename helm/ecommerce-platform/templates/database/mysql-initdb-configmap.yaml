{{- if .Values.mysql.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-initdb
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "ecommerce-platform.mysql.labels" . | nindent 4 }}
data:
  01-init.sql: |
    USE {{ .Values.mysql.auth.database }};
    
    CREATE TABLE IF NOT EXISTS customers (
      customer_id INT PRIMARY KEY AUTO_INCREMENT,
      first_name VARCHAR(100),
      last_name VARCHAR(100),
      email VARCHAR(255) UNIQUE,
      phone VARCHAR(20),
      address TEXT,
      city VARCHAR(100),
      state VARCHAR(50),
      country VARCHAR(50),
      postal_code VARCHAR(20),
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
      INDEX idx_email (email),
      INDEX idx_city (city)
    );
    
    CREATE TABLE IF NOT EXISTS products (
      product_id INT PRIMARY KEY AUTO_INCREMENT,
      product_name VARCHAR(255) NOT NULL,
      category VARCHAR(100),
      subcategory VARCHAR(100),
      brand VARCHAR(100),
      price DECIMAL(10, 2) NOT NULL,
      cost DECIMAL(10, 2),
      stock_quantity INT DEFAULT 0,
      description TEXT,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
      INDEX idx_category (category),
      INDEX idx_brand (brand)
    );
    
    CREATE TABLE IF NOT EXISTS orders (
      order_id INT PRIMARY KEY AUTO_INCREMENT,
      customer_id INT NOT NULL,
      order_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      total_amount DECIMAL(10, 2) NOT NULL,
      status VARCHAR(50) DEFAULT 'pending',
      payment_method VARCHAR(50),
      shipping_address TEXT,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
      FOREIGN KEY (customer_id) REFERENCES customers(customer_id),
      INDEX idx_customer (customer_id),
      INDEX idx_status (status),
      INDEX idx_order_date (order_date)
    );
    
    CREATE TABLE IF NOT EXISTS order_items (
      order_item_id INT PRIMARY KEY AUTO_INCREMENT,
      order_id INT NOT NULL,
      product_id INT NOT NULL,
      quantity INT NOT NULL,
      unit_price DECIMAL(10, 2) NOT NULL,
      subtotal DECIMAL(10, 2) NOT NULL,
      FOREIGN KEY (order_id) REFERENCES orders(order_id),
      FOREIGN KEY (product_id) REFERENCES products(product_id),
      INDEX idx_order (order_id),
      INDEX idx_product (product_id)
    );
    
    -- Sample data
    INSERT INTO customers (first_name, last_name, email, phone, city, state, country) VALUES
    ('John', 'Doe', 'john.doe@email.com', '555-0101', 'New York', 'NY', 'USA'),
    ('Jane', 'Smith', 'jane.smith@email.com', '555-0102', 'Los Angeles', 'CA', 'USA'),
    ('Bob', 'Johnson', 'bob.johnson@email.com', '555-0103', 'Chicago', 'IL', 'USA');
    
    INSERT INTO products (product_name, category, brand, price, cost, stock_quantity) VALUES
    ('Laptop Pro 15', 'Electronics', 'TechBrand', 1299.99, 899.99, 50),
    ('Wireless Mouse', 'Electronics', 'TechBrand', 29.99, 15.99, 200),
    ('Mechanical Keyboard', 'Electronics', 'TechBrand', 89.99, 45.99, 150);
    
    INSERT INTO orders (customer_id, total_amount, status, payment_method) VALUES
    (1, 1419.97, 'completed', 'credit_card'),
    (2, 89.99, 'processing', 'paypal'),
    (3, 1299.99, 'shipped', 'credit_card');
    
    INSERT INTO order_items (order_id, product_id, quantity, unit_price, subtotal) VALUES
    (1, 1, 1, 1299.99, 1299.99),
    (1, 3, 1, 89.99, 89.99),
    (2, 3, 1, 89.99, 89.99);
{{- end }}