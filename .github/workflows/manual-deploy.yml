name: Manual Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production
      image-tag:
        description: 'Docker image tag'
        required: true
        default: 'latest'
      skip-tests:
        description: 'Skip tests'
        required: false
        type: boolean
        default: false

jobs:
  manual-deploy:
    name: Manual Deploy to ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deployment Info
        run: |
          echo "=========================================="
          echo "MANUAL DEPLOYMENT"
          echo "=========================================="
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Image Tag: ${{ github.event.inputs.image-tag }}"
          echo "Skip Tests: ${{ github.event.inputs.skip-tests }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "=========================================="

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.12.0'

      - name: Validate Helm chart
        run: |
          helm lint helm/ecommerce-platform/ \
            -f helm/ecommerce-platform/values-${{ github.event.inputs.environment }}.yaml

      - name: Dry run
        run: |
          helm template ecommerce-${{ github.event.inputs.environment }} \
            helm/ecommerce-platform/ \
            -f helm/ecommerce-platform/values-${{ github.event.inputs.environment }}.yaml \
            --set application.image.tag=${{ github.event.inputs.image-tag }}

      - name: Deployment complete
        run: |
          echo "âœ… Manual deployment validated successfully!"
          echo "ðŸ“¦ Ready to deploy: ${{ secrets.DOCKERHUB_USERNAME }}/ecommerce-app:${{ github.event.inputs.image-tag }}"